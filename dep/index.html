<meta http-equiv="content-type" content="application/javascript; charset=UTF-8">
<script src="../js/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js" charset="utf-8"></script>

<script>
(function() {
    'use strict'

    //http://stackoverflow.com/questions/979975/how-to-get-the-value-from-the-url-parameter
    var QueryString = function () {
      var query_string = {};
      var query = window.location.search.substring(1);
      var vars = query.split("&");
      for (var i=0;i<vars.length;i++) {
        var pair = vars[i].split("=");
        if (typeof query_string[pair[0]] === "undefined") {
          query_string[pair[0]] = decodeURIComponent(pair[1]);
        } else if (typeof query_string[pair[0]] === "string") {
          var arr = [ query_string[pair[0]],decodeURIComponent(pair[1]) ];
          query_string[pair[0]] = arr;
        } else {
          query_string[pair[0]].push(decodeURIComponent(pair[1]));
        }
      } 
        return query_string;
    }();

    if(!QueryString.filename) {
        error();
    } else {
        d3.text('../matlab_in/dependencies.csv.deps', function(data_dependencies) {
            d3.text('../misc/dependencies.csv.files', function(data_files) {
                var dependencies = [];
                var fileNames = [];

                data_dependencies.split('\n').forEach(function(line) {
                    var d = line.split(',');
                    dependencies.push({from: d[0], to: d[1]});
                });

                data_files.split('\n').forEach(function(line) {
                    var fileName = '';
                    var startRecordingPath;

                    line.split('/').forEach(function(d, i) {
                        if(d === 'understand_in') {
                            startRecordingPath = i;
                        }

                        if(i > (startRecordingPath + 1)) {
                            fileName += '/' + d;
                        }
                    });

                    fileNames.push(fileName);
                });

                //lookup file number for this file name
                var fileNumber = fileNames.indexOf('/' + QueryString.filename);
                
                if(fileNumber === -1) {
                    error();
                } else {
                    fileNumber += 1; //1-indexed

                    var fanIn = dependencies.filter(function(d) {
                        return d.to == fileNumber;
                    });

                    var fanOut = dependencies.filter(function(d) {
                        return d.from == fileNumber;
                    });

                    var json = {file: QueryString.filename, fanIn: [], fanOut: []};

                    fanIn.forEach(function(d) {
                        json.fanIn.push(fileNames[d.from].substr(1));
                    });

                    fanOut.forEach(function(d) {
                        json.fanOut.push(fileNames[d.to].substr(1));
                    });

                    console.log(json);
                    document.write('<pre>' + JSON.stringify(json, null, '  ') + '</pre>');

                    if(QueryString.download === 'true') {
                        var blob = new Blob([JSON.stringify(json)], {type: "text/json;charset=utf-8"});
                        saveAs(blob, "data.json");
                    }
                }
            });
        });
    }

    function error() {
        var json = {error: 'File name missing or does not exist in the codebase, usage: https://metrics.mozilla.com/code-quality/dep/?filename=xpcom/glue/nsINIParser.cpp'};
        document.write('<pre>' + JSON.stringify(json, null, '  ') + '</pre>');

        if(QueryString.download === 'true') {
            var blob = new Blob([JSON.stringify(json)], {type: "text/json;charset=utf-8"});
            saveAs(blob, "data.json");
        }
    }
}());
</script>